<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Registro de Vehículos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="h-8 w-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-car text-white"></i>
                    </div>
                    <h1 class="ml-3 text-xl font-semibold text-gray-900">Mis Vehículos</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-sm text-gray-700"></span>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <!-- Stats will be loaded here -->
        </div>

        <!-- Actions Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <h2 class="text-2xl font-bold text-gray-900">Lista de Vehículos</h2>
            <div class="flex space-x-3">
                <button id="addVehicleBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition duration-200 transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Agregar Vehículo
                </button>
                <button id="refreshBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Estado</label>
                    <select id="filterEstado" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activo</option>
                        <option value="vendido">Vendido</option>
                        <option value="siniestrado">Siniestrado</option>
                        <option value="en_mantenimiento">En Mantenimiento</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Tipo</label>
                    <select id="filterTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos los tipos</option>
                        <option value="automovil">Automóvil</option>
                        <option value="motocicleta">Motocicleta</option>
                        <option value="camion">Camión</option>
                        <option value="suv">SUV</option>
                        <option value="van">Van</option>
                        <option value="pickup">Pickup</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                    <input type="text" id="searchInput" placeholder="Buscar por placa, marca o modelo..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </div>

        <!-- Vehicles Table -->
        <div class="bg-white shadow-sm rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registro</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Vehicles will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty state -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-car text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay vehículos registrados</h3>
                <p class="text-gray-500 mb-4">Comienza agregando tu primer vehículo</p>
                <button id="addFirstVehicle" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition duration-200">
                    <i class="fas fa-plus mr-2"></i>Agregar Primer Vehículo
                </button>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-700">
                <span id="paginationInfo"></span>
            </div>
            <div class="flex space-x-2">
                <button id="prevBtn" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="nextBtn" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span>Cargando...</span>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alert" class="hidden fixed top-4 right-4 max-w-sm w-full bg-red-500 text-white p-4 rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="alertText"></span>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let vehiculos = [];

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            const usuario = localStorage.getItem('usuario');
            
            if (!token || !usuario) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = JSON.parse(usuario);
            document.getElementById('userName').textContent = `Hola, ${user.nombre}`;
        }

        // Show alert
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            const alertText = document.getElementById('alertText');
            
            alertText.textContent = message;
            alert.className = `fixed top-4 right-4 max-w-sm w-full p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // Show loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        // Hide loading
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // API call helper
        async function apiCall(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            return fetch(url, { ...defaultOptions, ...options });
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await apiCall('/api/vehiculos/estadisticas');
                const stats = await response.json();
                
                if (response.ok) {
                    renderStats(stats);
                }
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Render statistics
        function renderStats(stats) {
            const statsSection = document.getElementById('statsSection');
            statsSection.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-blue-100 rounded-full">
                            <i class="fas fa-car text-blue-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Total Vehículos</p>
                            <p class="text-2xl font-semibold text-gray-900">${stats.total || 0}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-green-100 rounded-full">
                            <i class="fas fa-check-circle text-green-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Activos</p>
                            <p class="text-2xl font-semibold text-gray-900">${stats.porEstado?.activo || 0}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-yellow-100 rounded-full">
                            <i class="fas fa-calendar text-yellow-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">Año Promedio</p>
                            <p class="text-2xl font-semibold text-gray-900">${stats.añoPromedio || 0}</p>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-sm">
                    <div class="flex items-center">
                        <div class="p-3 bg-purple-100 rounded-full">
                            <i class="fas fa-road text-purple-600 text-xl"></i>
                        </div>
                        <div class="ml-4">
                            <p class="text-sm text-gray-600">KM Promedio</p>
                            <p class="text-2xl font-semibold text-gray-900">${Math.round(stats.kilometrajePromedio || 0).toLocaleString()}</p>
                        </div>
                    </div>
                </div>
            `;
        }

        // Load vehicles
        async function loadVehicles(page = 1, filters = {}) {
            showLoading();
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 10,
                    ...filters
                });
                
                const response = await apiCall(`/api/vehiculos?${params}`);
                const data = await response.json();
                
                if (response.ok) {
                    vehiculos = data.vehiculos;
                    currentPage = parseInt(data.paginaActual);
                    totalPages = data.totalPaginas;
                    
                    renderVehicles(vehiculos);
                    updatePagination(data);
                } else {
                    showAlert(data.error || 'Error al cargar vehículos');
                }
            } catch (error) {
                showAlert('Error de conexión');
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        // Render vehicles
        function renderVehicles(vehicles) {
            const tbody = document.getElementById('vehiclesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (vehicles.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = vehicles.map(vehiculo => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-car text-indigo-600"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${vehiculo.marca} ${vehiculo.modelo}</div>
                                <div class="text-sm text-gray-500">Año ${vehiculo.año} • ${vehiculo.color}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${vehiculo.placa}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getEstadoBadge(vehiculo.estado)}">
                            ${vehiculo.estado.replace('_', ' ')}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        ${vehiculo.tipoVehiculo}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(vehiculo.fechaRegistro).toLocaleDateString()}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end space-x-2">
                            <button onclick="viewVehicle('${vehiculo._id}')" class="text-indigo-600 hover:text-indigo-900">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editVehicle('${vehiculo._id}')" class="text-yellow-600 hover:text-yellow-900">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteVehicle('${vehiculo._id}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Get estado badge color
        function getEstadoBadge(estado) {
            const badges = {
                'activo': 'bg-green-100 text-green-800',
                'vendido': 'bg-blue-100 text-blue-800',
                'siniestrado': 'bg-red-100 text-red-800',
                'en_mantenimiento': 'bg-yellow-100 text-yellow-800'
            };
            return badges[estado] || 'bg-gray-100 text-gray-800';
        }

        // Update pagination
        function updatePagination(data) {
            document.getElementById('paginationInfo').textContent = 
                `Mostrando ${data.vehiculos.length} de ${data.total} vehículos`;
            
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        }

        // Vehicle actions
        function viewVehicle(id) {
            window.location.href = `vehiculo-detalle.html?id=${id}`;
        }

        function editVehicle(id) {
            window.location.href = `vehiculo-form.html?id=${id}`;
        }

        async function deleteVehicle(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este vehículo?')) {
                return;
            }
            
            try {
                const response = await apiCall(`/api/vehiculos/${id}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert('Vehículo eliminado correctamente', 'success');
                    loadVehicles(currentPage);
                    loadStats();
                } else {
                    showAlert(result.error || 'Error al eliminar vehículo');
                }
            } catch (error) {
                showAlert('Error de conexión');
                console.error('Error:', error);
            }
        }

        // Get filters
        function getFilters() {
            const estado = document.getElementById('filterEstado').value;
            const tipoVehiculo = document.getElementById('filterTipo').value;
            const search = document.getElementById('searchInput').value;
            
            const filters = {};
            if (estado) filters.estado = estado;
            if (tipoVehiculo) filters.tipoVehiculo = tipoVehiculo;
            // Note: Backend search functionality would need to be implemented
            
            return filters;
        }

        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', () => {
            localStorage.clear();
            window.location.href = 'login.html';
        });

        document.getElementById('addVehicleBtn').addEventListener('click', () => {
            window.location.href = 'vehiculo-form.html';
        });

        document.getElementById('addFirstVehicle').addEventListener('click', () => {
            window.location.href = 'vehiculo-form.html';
        });

        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadVehicles(currentPage, getFilters());
            loadStats();
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
            if (currentPage > 1) {
                loadVehicles(currentPage - 1, getFilters());
            }
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
            if (currentPage < totalPages) {
                loadVehicles(currentPage + 1, getFilters());
            }
        });

        // Filter event listeners
        document.getElementById('filterEstado').addEventListener('change', () => {
            loadVehicles(1, getFilters());
        });

        document.getElementById('filterTipo').addEventListener('change', () => {
            loadVehicles(1, getFilters());
        });

        document.getElementById('searchInput').addEventListener('input', debounce(() => {
            loadVehicles(1, getFilters());
        }, 500));

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            loadStats();
            loadVehicles();
        });
    </script>
</body>
</html>