<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formulario de Vehículo - Registro de Vehículos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <a href="dashboard.html" class="flex items-center text-gray-600 hover:text-gray-900">
                        <i class="fas fa-arrow-left mr-2"></i>
                        <span>Volver al Dashboard</span>
                    </a>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-sm text-gray-700"></span>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Header -->
        <div class="mb-8">
            <h1 id="pageTitle" class="text-3xl font-bold text-gray-900">Agregar Nuevo Vehículo</h1>
            <p class="mt-2 text-gray-600">Complete la información del vehículo</p>
        </div>

        <!-- Form -->
        <form id="vehicleForm" class="space-y-8">
            <!-- Basic Information -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-info-circle text-gray-400 mr-2"></i>
                        Información Básica
                    </h3>
                </div>
                
                <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Marca -->
                    <div>
                        <label for="marca" class="block text-sm font-medium text-gray-700 mb-2">
                            Marca *
                        </label>
                        <input type="text" id="marca" name="marca" required 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="Toyota, Honda, Ford...">
                        <div id="marca-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Modelo -->
                    <div>
                        <label for="modelo" class="block text-sm font-medium text-gray-700 mb-2">
                            Modelo *
                        </label>
                        <input type="text" id="modelo" name="modelo" required 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="Corolla, Civic, Focus...">
                        <div id="modelo-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Año -->
                    <div>
                        <label for="año" class="block text-sm font-medium text-gray-700 mb-2">
                            Año *
                        </label>
                        <input type="number" id="año" name="año" required min="1900" max="2025"
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="2020">
                        <div id="año-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Placa -->
                    <div>
                        <label for="placa" class="block text-sm font-medium text-gray-700 mb-2">
                            Placa *
                        </label>
                        <input type="text" id="placa" name="placa" required 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="ABC123" style="text-transform: uppercase;">
                        <div id="placa-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Color -->
                    <div>
                        <label for="color" class="block text-sm font-medium text-gray-700 mb-2">
                            Color *
                        </label>
                        <input type="text" id="color" name="color" required 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="Rojo, Azul, Negro...">
                        <div id="color-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Tipo de Vehículo -->
                    <div>
                        <label for="tipoVehiculo" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de Vehículo *
                        </label>
                        <select id="tipoVehiculo" name="tipoVehiculo" required 
                                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                            <option value="">Seleccione un tipo</option>
                            <option value="automovil">Automóvil</option>
                            <option value="motocicleta">Motocicleta</option>
                            <option value="camion">Camión</option>
                            <option value="suv">SUV</option>
                            <option value="van">Van</option>
                            <option value="pickup">Pickup</option>
                        </select>
                        <div id="tipoVehiculo-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Technical Information -->
            <div class="bg-white shadow-lg rounded-lg overflow-hidden">
                <div class="px-6 py-4 bg-gray-50 border-b border-gray-200">
                    <h3 class="text-lg font-medium text-gray-900">
                        <i class="fas fa-cogs text-gray-400 mr-2"></i>
                        Información Técnica
                    </h3>
                </div>
                
                <div class="px-6 py-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Combustible -->
                    <div>
                        <label for="combustible" class="block text-sm font-medium text-gray-700 mb-2">
                            Tipo de Combustible
                        </label>
                        <select id="combustible" name="combustible" 
                                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                            <option value="gasolina">Gasolina</option>
                            <option value="diesel">Diesel</option>
                            <option value="electrico">Eléctrico</option>
                            <option value="hibrido">Híbrido</option>
                            <option value="gas">Gas</option>
                        </select>
                    </div>

                    <!-- Kilometraje -->
                    <div>
                        <label for="kilometraje" class="block text-sm font-medium text-gray-700 mb-2">
                            Kilometraje
                        </label>
                        <input type="number" id="kilometraje" name="kilometraje" min="0" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="50000">
                        <div id="kilometraje-error" class="text-red-600 text-sm mt-1 hidden"></div>
                    </div>

                    <!-- Número de Chasis -->
                    <div>
                        <label for="numeroChasis" class="block text-sm font-medium text-gray-700 mb-2">
                            Número de Chasis
                        </label>
                        <input type="text" id="numeroChasis" name="numeroChasis" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="Opcional">
                    </div>

                    <!-- Número de Motor -->
                    <div>
                        <label for="numeroMotor" class="block text-sm font-medium text-gray-700 mb-2">
                            Número de Motor
                        </label>
                        <input type="text" id="numeroMotor" name="numeroMotor" 
                               class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200"
                               placeholder="Opcional">
                    </div>

                    <!-- Estado (solo para edición) -->
                    <div id="estadoSection" class="hidden md:col-span-2">
                        <label for="estado" class="block text-sm font-medium text-gray-700 mb-2">
                            Estado del Vehículo
                        </label>
                        <select id="estado" name="estado" 
                                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-200">
                            <option value="activo">Activo</option>
                            <option value="vendido">Vendido</option>
                            <option value="siniestrado">Siniestrado</option>
                            <option value="en_mantenimiento">En Mantenimiento</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Form Actions -->
            <div class="flex justify-end space-x-4">
                <button type="button" id="cancelBtn" 
                        class="px-6 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                    Cancelar
                </button>
                <button type="submit" id="submitBtn"
                        class="px-6 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition duration-200 flex items-center">
                    <span id="submitText">Guardar Vehículo</span>
                    <div id="submitSpinner" class="hidden ml-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"></div>
                    </div>
                </button>
            </div>
        </form>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <i id="confirmIcon" class="fas fa-sign-out-alt text-blue-500 text-2xl mr-3"></i>
                <h3 id="confirmTitle" class="text-lg font-medium text-gray-900">Cerrar Sesión</h3>
            </div>
            
            <p id="confirmMessage" class="text-gray-600 mb-6">¿Estás seguro de que deseas cerrar sesión?</p>
            
            <div class="flex justify-end space-x-3">
                <button id="cancelConfirm" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                    Cancelar
                </button>
                <button id="acceptConfirm" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alert" class="hidden fixed top-4 right-4 max-w-sm w-full bg-red-500 text-white p-4 rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="alertText"></span>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span>Cargando...</span>
            </div>
        </div>
    </div>

    <script>
        let isEditMode = false;
        let vehicleId = null;

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            const usuario = localStorage.getItem('usuario');
            
            if (!token || !usuario) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = JSON.parse(usuario);
            document.getElementById('userName').textContent = `Hola, ${user.nombre}`;
        }

        // Show alert
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            const alertText = document.getElementById('alertText');
            
            alertText.textContent = message;
            alert.className = `fixed top-4 right-4 max-w-sm w-full p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // Show confirmation modal
        function showConfirmModal(title, message, onConfirm) {
            const modal = document.getElementById('confirmModal');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            modal.classList.remove('hidden');
            
            const handleConfirm = () => {
                modal.classList.add('hidden');
                onConfirm();
                acceptBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                modal.classList.add('hidden');
                acceptBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const acceptBtn = document.getElementById('acceptConfirm');
            const cancelBtn = document.getElementById('cancelConfirm');
            acceptBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // API call helper
        async function apiCall(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            return fetch(url, { ...defaultOptions, ...options });
        }

        // Clear field errors
        function clearFieldError(fieldName) {
            const errorDiv = document.getElementById(`${fieldName}-error`);
            const field = document.getElementById(fieldName);
            
            if (errorDiv) {
                errorDiv.classList.add('hidden');
                errorDiv.textContent = '';
            }
            
            if (field) {
                field.classList.remove('border-red-500');
                field.classList.add('border-gray-300');
            }
        }

        // Show field error
        function showFieldError(fieldName, message) {
            const errorDiv = document.getElementById(`${fieldName}-error`);
            const field = document.getElementById(fieldName);
            
            if (errorDiv) {
                errorDiv.classList.remove('hidden');
                errorDiv.textContent = message;
            }
            
            if (field) {
                field.classList.add('border-red-500');
                field.classList.remove('border-gray-300');
            }
        }

        // Clear all errors
        function clearAllErrors() {
            const fields = ['marca', 'modelo', 'año', 'placa', 'color', 'tipoVehiculo', 'kilometraje'];
            fields.forEach(field => clearFieldError(field));
        }

        // Load vehicle data for editing
        async function loadVehicleData(id) {
            showLoading();
            try {
                const response = await apiCall(`/api/vehiculos/${id}`);
                
                if (response.ok) {
                    const data = await response.json();
                    populateForm(data.vehiculo);
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al cargar vehículo');
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 2000);
                }
            } catch (error) {
                showAlert('Error de conexión');
                console.error('Error:', error);
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 2000);
            } finally {
                hideLoading();
            }
        }

        // Populate form with vehicle data
        function populateForm(vehiculo) {
            document.getElementById('marca').value = vehiculo.marca || '';
            document.getElementById('modelo').value = vehiculo.modelo || '';
            document.getElementById('año').value = vehiculo.año || '';
            document.getElementById('placa').value = vehiculo.placa || '';
            document.getElementById('color').value = vehiculo.color || '';
            document.getElementById('tipoVehiculo').value = vehiculo.tipoVehiculo || '';
            document.getElementById('combustible').value = vehiculo.combustible || 'gasolina';
            document.getElementById('kilometraje').value = vehiculo.kilometraje || '';
            document.getElementById('numeroChasis').value = vehiculo.numeroChasis || '';
            document.getElementById('numeroMotor').value = vehiculo.numeroMotor || '';
            
            if (isEditMode) {
                document.getElementById('estado').value = vehiculo.estado || 'activo';
            }
        }

        // Get form data
        function getFormData() {
            const formData = new FormData(document.getElementById('vehicleForm'));
            const data = {};
            
            for (let [key, value] of formData.entries()) {
                if (value.trim() !== '') {
                    data[key] = value.trim();
                }
            }
            
            // Convert año and kilometraje to numbers
            if (data.año) data.año = parseInt(data.año);
            if (data.kilometraje) data.kilometraje = parseInt(data.kilometraje);
            
            return data;
        }

        // Validate form
        function validateForm(data) {
            clearAllErrors();
            let isValid = true;
            
            // Required fields
            const requiredFields = {
                'marca': 'La marca es requerida',
                'modelo': 'El modelo es requerido',
                'año': 'El año es requerido',
                'placa': 'La placa es requerida',
                'color': 'El color es requerido',
                'tipoVehiculo': 'El tipo de vehículo es requerido'
            };
            
            for (let [field, message] of Object.entries(requiredFields)) {
                if (!data[field]) {
                    showFieldError(field, message);
                    isValid = false;
                }
            }
            
            // Validate año
            if (data.año) {
                const currentYear = new Date().getFullYear();
                if (data.año < 1900 || data.año > currentYear + 1) {
                    showFieldError('año', `El año debe estar entre 1900 y ${currentYear + 1}`);
                    isValid = false;
                }
            }
            
            // Validate kilometraje
            if (data.kilometraje !== undefined && data.kilometraje < 0) {
                showFieldError('kilometraje', 'El kilometraje no puede ser negativo');
                isValid = false;
            }
            
            // Validate placa format (basic validation)
            if (data.placa && data.placa.length < 3) {
                showFieldError('placa', 'La placa debe tener al menos 3 caracteres');
                isValid = false;
            }
            
            return isValid;
        }

        // Submit form
        async function submitForm(e) {
            e.preventDefault();
            
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const submitSpinner = document.getElementById('submitSpinner');
            
            // Get and validate form data
            const data = getFormData();
            if (!validateForm(data)) {
                return;
            }
            
            // Show loading state
            submitBtn.disabled = true;
            submitText.textContent = isEditMode ? 'Actualizando...' : 'Guardando...';
            submitSpinner.classList.remove('hidden');
            
            try {
                const url = isEditMode ? `/api/vehiculos/${vehicleId}` : '/api/vehiculos';
                const method = isEditMode ? 'PUT' : 'POST';
                
                const response = await apiCall(url, {
                    method: method,
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showAlert(
                        isEditMode ? 'Vehículo actualizado correctamente' : 'Vehículo creado correctamente', 
                        'success'
                    );
                    
                    setTimeout(() => {
                        window.location.href = 'dashboard.html';
                    }, 1500);
                } else {
                    if (result.error && result.error.includes('placa')) {
                        showFieldError('placa', 'Ya existe un vehículo con esta placa');
                    } else if (result.error && result.error.includes('chasis')) {
                        showFieldError('numeroChasis', 'Ya existe un vehículo con este número de chasis');
                    } else if (result.error && result.error.includes('motor')) {
                        showFieldError('numeroMotor', 'Ya existe un vehículo con este número de motor');
                    } else {
                        showAlert(result.error || 'Error al guardar vehículo');
                    }
                }
            } catch (error) {
                showAlert('Error de conexión');
                console.error('Error:', error);
            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                submitText.textContent = isEditMode ? 'Actualizar Vehículo' : 'Guardar Vehículo';
                submitSpinner.classList.add('hidden');
            }
        }

        // Go back to dashboard
        function goToDashboard() {
            window.location.href = 'dashboard.html';
        }

        // Logout function
        function performLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Event listeners
        document.getElementById('vehicleForm').addEventListener('submit', submitForm);

        document.getElementById('cancelBtn').addEventListener('click', () => {
            goToDashboard();
        });

        document.getElementById('logoutBtn').addEventListener('click', () => {
            showConfirmModal(
                'Cerrar Sesión',
                '¿Estás seguro de que deseas cerrar sesión?',
                performLogout
            );
        });

        // Make placa uppercase and clear error on input
        document.getElementById('placa').addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
            clearFieldError('placa');
        });

        // Clear errors on input for all fields
        ['marca', 'modelo', 'año', 'color', 'tipoVehiculo', 'kilometraje'].forEach(fieldName => {
            const field = document.getElementById(fieldName);
            if (field) {
                field.addEventListener('input', () => clearFieldError(fieldName));
                if (field.tagName === 'SELECT') {
                    field.addEventListener('change', () => clearFieldError(fieldName));
                }
            }
        });

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            
            // Check if editing
            const urlParams = new URLSearchParams(window.location.search);
            vehicleId = urlParams.get('id');
            
            if (vehicleId) {
                isEditMode = true;
                document.getElementById('pageTitle').textContent = 'Editar Vehículo';
                document.getElementById('submitText').textContent = 'Actualizar Vehículo';
                document.getElementById('estadoSection').classList.remove('hidden');
                
                loadVehicleData(vehicleId);
            } else {
                // Set current year as default
                document.getElementById('año').value = new Date().getFullYear();
            }
        });
    </script>
</body>
</html>