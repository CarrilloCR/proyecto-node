<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Registro de Vehículos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <div class="h-8 w-8 bg-indigo-600 rounded-lg flex items-center justify-center">
                        <i class="fas fa-car text-white"></i>
                    </div>
                    <h1 class="ml-3 text-xl font-semibold text-gray-900">Mis Vehículos</h1>
                </div>
                
                <div class="flex items-center space-x-4">
                    <span id="userName" class="text-sm text-gray-700"></span>
                    <button id="profileBtn" class="text-gray-600 hover:text-gray-900 px-3 py-2 rounded-lg hover:bg-gray-100 transition duration-200">
                        <i class="fas fa-user mr-2"></i>Perfil
                    </button>
                    <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg text-sm transition duration-200">
                        <i class="fas fa-sign-out-alt mr-2"></i>Cerrar Sesión
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <!-- Stats Cards -->
        <div id="statsSection" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 bg-blue-100 rounded-full">
                        <i class="fas fa-car text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Total Vehículos</p>
                        <p id="totalVehiculos" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 bg-green-100 rounded-full">
                        <i class="fas fa-check-circle text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Activos</p>
                        <p id="vehiculosActivos" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 bg-yellow-100 rounded-full">
                        <i class="fas fa-calendar text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">Año Promedio</p>
                        <p id="anoPromedio" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
            
            <div class="bg-white p-6 rounded-lg shadow-sm">
                <div class="flex items-center">
                    <div class="p-3 bg-purple-100 rounded-full">
                        <i class="fas fa-road text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm text-gray-600">KM Promedio</p>
                        <p id="kmPromedio" class="text-2xl font-semibold text-gray-900">0</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Actions Header -->
        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 space-y-4 sm:space-y-0">
            <h2 class="text-2xl font-bold text-gray-900">Lista de Vehículos</h2>
            <div class="flex space-x-3">
                <button id="addVehicleBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition duration-200 transform hover:scale-105">
                    <i class="fas fa-plus mr-2"></i>Agregar Vehículo
                </button>
                <button id="refreshBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg transition duration-200">
                    <i class="fas fa-sync-alt mr-2"></i>Actualizar
                </button>
            </div>
        </div>

        <!-- Filters -->
        <div class="bg-white p-4 rounded-lg shadow-sm mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Estado</label>
                    <select id="filterEstado" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos los estados</option>
                        <option value="activo">Activo</option>
                        <option value="vendido">Vendido</option>
                        <option value="siniestrado">Siniestrado</option>
                        <option value="en_mantenimiento">En Mantenimiento</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Filtrar por Tipo</label>
                    <select id="filterTipo" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="">Todos los tipos</option>
                        <option value="automovil">Automóvil</option>
                        <option value="motocicleta">Motocicleta</option>
                        <option value="camion">Camión</option>
                        <option value="suv">SUV</option>
                        <option value="van">Van</option>
                        <option value="pickup">Pickup</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Buscar</label>
                    <input type="text" id="searchInput" placeholder="Buscar por placa, marca o modelo..." 
                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
        </div>

        <!-- Vehicles Table -->
        <div class="bg-white shadow-sm rounded-lg overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Vehículo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Placa</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tipo</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Registro</th>
                            <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="vehiclesTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Vehicles will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Empty state -->
            <div id="emptyState" class="hidden text-center py-12">
                <i class="fas fa-car text-gray-400 text-6xl mb-4"></i>
                <h3 class="text-lg font-medium text-gray-900 mb-2">No hay vehículos registrados</h3>
                <p class="text-gray-500 mb-4">Comienza agregando tu primer vehículo</p>
                <button id="addFirstVehicle" class="bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-lg transition duration-200">
                    <i class="fas fa-plus mr-2"></i>Agregar Primer Vehículo
                </button>
            </div>
        </div>

        <!-- Pagination -->
        <div id="pagination" class="flex justify-between items-center mt-6">
            <div class="text-sm text-gray-700">
                <span id="paginationInfo">Mostrando 0 de 0 vehículos</span>
            </div>
            <div class="flex space-x-2">
                <button id="prevBtn" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button id="nextBtn" class="px-3 py-1 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg max-w-md w-full mx-4">
            <div class="flex items-center mb-4">
                <i id="confirmIcon" class="text-2xl mr-3"></i>
                <h3 id="confirmTitle" class="text-lg font-medium text-gray-900"></h3>
            </div>
            
            <p id="confirmMessage" class="text-gray-600 mb-6"></p>
            
            <div class="flex justify-end space-x-3">
                <button id="cancelConfirm" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition duration-200">
                    Cancelar
                </button>
                <button id="acceptConfirm" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-200">
                    Confirmar
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-indigo-600"></div>
                <span>Cargando...</span>
            </div>
        </div>
    </div>

    <!-- Alert -->
    <div id="alert" class="hidden fixed top-4 right-4 max-w-sm w-full bg-red-500 text-white p-4 rounded-lg shadow-lg z-50">
        <div class="flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            <span id="alertText"></span>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let totalPages = 1;
        let vehiculos = [];
        let filteredVehiculos = [];

        // Check authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            const usuario = localStorage.getItem('usuario');
            
            if (!token || !usuario) {
                window.location.href = 'login.html';
                return;
            }
            
            const user = JSON.parse(usuario);
            document.getElementById('userName').textContent = `Hola, ${user.nombre}`;
        }

        // Show alert
        function showAlert(message, type = 'error') {
            const alert = document.getElementById('alert');
            const alertText = document.getElementById('alertText');
            
            alertText.textContent = message;
            alert.className = `fixed top-4 right-4 max-w-sm w-full p-4 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white`;
            alert.classList.remove('hidden');
            
            setTimeout(() => {
                alert.classList.add('hidden');
            }, 5000);
        }

        // Show confirmation modal
        function showConfirmModal(title, message, onConfirm, type = 'danger') {
            const modal = document.getElementById('confirmModal');
            const icon = document.getElementById('confirmIcon');
            const titleEl = document.getElementById('confirmTitle');
            const messageEl = document.getElementById('confirmMessage');
            const acceptBtn = document.getElementById('acceptConfirm');
            
            titleEl.textContent = title;
            messageEl.textContent = message;
            
            if (type === 'logout') {
                icon.className = 'fas fa-sign-out-alt text-blue-500 text-2xl mr-3';
                acceptBtn.className = 'px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition duration-200';
                acceptBtn.textContent = 'Cerrar Sesión';
            } else {
                icon.className = 'fas fa-exclamation-triangle text-red-500 text-2xl mr-3';
                acceptBtn.className = 'px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition duration-200';
                acceptBtn.textContent = 'Eliminar';
            }
            
            modal.classList.remove('hidden');
            
            // Set up one-time event listeners
            const handleConfirm = () => {
                modal.classList.add('hidden');
                onConfirm();
                acceptBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const handleCancel = () => {
                modal.classList.add('hidden');
                acceptBtn.removeEventListener('click', handleConfirm);
                cancelBtn.removeEventListener('click', handleCancel);
            };
            
            const cancelBtn = document.getElementById('cancelConfirm');
            acceptBtn.addEventListener('click', handleConfirm);
            cancelBtn.addEventListener('click', handleCancel);
        }

        // Show/hide loading
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        // API call helper
        async function apiCall(url, options = {}) {
            const token = localStorage.getItem('token');
            const defaultOptions = {
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                }
            };
            
            return fetch(url, { ...defaultOptions, ...options });
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await apiCall('/api/vehiculos/estadisticas');
                
                if (response.ok) {
                    const stats = await response.json();
                    updateStatsDisplay(stats);
                } else {
                    // If API fails, calculate from loaded vehicles
                    if (vehiculos.length > 0) {
                        const calculatedStats = calculateStatsFromVehicles(vehiculos);
                        updateStatsDisplay(calculatedStats);
                    }
                }
            } catch (error) {
                console.error('Error loading stats:', error);
                // Fallback to calculating from loaded vehicles
                if (vehiculos.length > 0) {
                    const calculatedStats = calculateStatsFromVehicles(vehiculos);
                    updateStatsDisplay(calculatedStats);
                }
            }
        }

        // Calculate statistics from vehicles array
        function calculateStatsFromVehicles(vehiclesArray) {
            if (!vehiclesArray || vehiclesArray.length === 0) {
                return {
                    total: 0,
                    porEstado: { activo: 0 },
                    añoPromedio: 0,
                    kilometrajePromedio: 0
                };
            }

            const total = vehiclesArray.length;
            const activos = vehiclesArray.filter(v => v.estado === 'activo').length;
            
            const años = vehiclesArray.filter(v => v.año).map(v => v.año);
            const añoPromedio = años.length > 0 ? Math.round(años.reduce((a, b) => a + b, 0) / años.length) : 0;
            
            const kms = vehiclesArray.filter(v => v.kilometraje && v.kilometraje > 0).map(v => v.kilometraje);
            const kmPromedio = kms.length > 0 ? Math.round(kms.reduce((a, b) => a + b, 0) / kms.length) : 0;

            return {
                total,
                porEstado: { activo: activos },
                añoPromedio,
                kilometrajePromedio: kmPromedio
            };
        }

        // Update statistics display
        function updateStatsDisplay(stats) {
            document.getElementById('totalVehiculos').textContent = stats.total || 0;
            document.getElementById('vehiculosActivos').textContent = stats.porEstado?.activo || 0;
            document.getElementById('anoPromedio').textContent = stats.añoPromedio || 0;
            document.getElementById('kmPromedio').textContent = (stats.kilometrajePromedio || 0).toLocaleString();
        }

        // Load vehicles
        async function loadVehicles(page = 1, filters = {}) {
            showLoading();
            try {
                const params = new URLSearchParams({
                    page: page,
                    limit: 50, // Increased to get more data for filtering
                    ...filters
                });
                
                const response = await apiCall(`/api/vehiculos?${params}`);
                
                if (response.ok) {
                    const data = await response.json();
                    vehiculos = data.vehiculos || [];
                    
                    // Apply search filter if exists
                    applyFilters();
                    
                    // Update statistics with all vehicles
                    const statsData = calculateStatsFromVehicles(vehiculos);
                    updateStatsDisplay(statsData);
                    
                } else {
                    const errorData = await response.json();
                    showAlert(errorData.error || 'Error al cargar vehículos');
                    vehiculos = [];
                    filteredVehiculos = [];
                }
            } catch (error) {
                showAlert('Error de conexión');
                console.error('Error:', error);
                vehiculos = [];
                filteredVehiculos = [];
            } finally {
                hideLoading();
            }
        }

        // Apply filters to vehicles
        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            filteredVehiculos = vehiculos.filter(vehiculo => {
                const matchesSearch = !searchTerm || 
                    vehiculo.placa.toLowerCase().includes(searchTerm) ||
                    vehiculo.marca.toLowerCase().includes(searchTerm) ||
                    vehiculo.modelo.toLowerCase().includes(searchTerm);
                
                return matchesSearch;
            });
            
            renderVehicles(filteredVehiculos);
            updatePagination();
        }

        // Render vehicles
        function renderVehicles(vehicles) {
            const tbody = document.getElementById('vehiclesTableBody');
            const emptyState = document.getElementById('emptyState');
            
            if (!vehicles || vehicles.length === 0) {
                tbody.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            tbody.innerHTML = vehicles.map(vehiculo => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="h-10 w-10 bg-indigo-100 rounded-full flex items-center justify-center">
                                <i class="fas fa-car text-indigo-600"></i>
                            </div>
                            <div class="ml-4">
                                <div class="text-sm font-medium text-gray-900">${vehiculo.marca} ${vehiculo.modelo}</div>
                                <div class="text-sm text-gray-500">Año ${vehiculo.año} • ${vehiculo.color}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="text-sm font-medium text-gray-900">${vehiculo.placa}</div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${getEstadoBadge(vehiculo.estado)}">
                            ${getEstadoText(vehiculo.estado)}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 capitalize">
                        ${getTipoText(vehiculo.tipoVehiculo)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${new Date(vehiculo.fechaRegistro).toLocaleDateString('es-ES')}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <div class="flex justify-end space-x-2">
                            <button onclick="viewVehicle('${vehiculo._id}')" class="text-indigo-600 hover:text-indigo-900 p-1" title="Ver detalles">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button onclick="editVehicle('${vehiculo._id}')" class="text-yellow-600 hover:text-yellow-900 p-1" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteVehicle('${vehiculo._id}', '${vehiculo.marca} ${vehiculo.modelo} - ${vehiculo.placa}')" class="text-red-600 hover:text-red-900 p-1" title="Eliminar">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        // Get estado badge color
        function getEstadoBadge(estado) {
            const badges = {
                'activo': 'bg-green-100 text-green-800',
                'vendido': 'bg-blue-100 text-blue-800',
                'siniestrado': 'bg-red-100 text-red-800',
                'en_mantenimiento': 'bg-yellow-100 text-yellow-800'
            };
            return badges[estado] || 'bg-gray-100 text-gray-800';
        }

        // Get estado text
        function getEstadoText(estado) {
            const textos = {
                'activo': 'Activo',
                'vendido': 'Vendido',
                'siniestrado': 'Siniestrado',
                'en_mantenimiento': 'En Mantenimiento'
            };
            return textos[estado] || estado;
        }

        // Get tipo text
        function getTipoText(tipo) {
            const textos = {
                'automovil': 'Automóvil',
                'motocicleta': 'Motocicleta',
                'camion': 'Camión',
                'suv': 'SUV',
                'van': 'Van',
                'pickup': 'Pickup'
            };
            return textos[tipo] || tipo;
        }

        // Update pagination info
        function updatePagination() {
            const total = filteredVehiculos.length;
            document.getElementById('paginationInfo').textContent = `Mostrando ${total} de ${vehiculos.length} vehículos`;
            
            // For now, disable pagination buttons as we're showing all results
            document.getElementById('prevBtn').disabled = true;
            document.getElementById('nextBtn').disabled = true;
        }

        // Vehicle actions
        function viewVehicle(id) {
            window.location.href = `vehiculo-detalle.html?id=${id}`;
        }

        function editVehicle(id) {
            window.location.href = `vehiculo-form.html?id=${id}`;
        }

        function deleteVehicle(id, vehicleName) {
            showConfirmModal(
                'Eliminar Vehículo',
                `¿Estás seguro de que deseas eliminar el vehículo ${vehicleName}? Esta acción no se puede deshacer.`,
                async () => {
                    await performDeleteVehicle(id);
                }
            );
        }

        async function performDeleteVehicle(id) {
            showLoading();
            try {
                const response = await apiCall(`/api/vehiculos/${id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showAlert('Vehículo eliminado correctamente', 'success');
                    await loadVehicles();
                } else {
                    const result = await response.json();
                    showAlert(result.error || 'Error al eliminar vehículo');
                }
            } catch (error) {
                showAlert('Error de conexión');
                console.error('Error:', error);
            } finally {
                hideLoading();
            }
        }

        // Get current filters
        function getCurrentFilters() {
            const estado = document.getElementById('filterEstado').value;
            const tipoVehiculo = document.getElementById('filterTipo').value;
            
            const filters = {};
            if (estado) filters.estado = estado;
            if (tipoVehiculo) filters.tipoVehiculo = tipoVehiculo;
            
            return filters;
        }

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Logout function
        function performLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        // Event listeners
        document.getElementById('logoutBtn').addEventListener('click', () => {
            showConfirmModal(
                'Cerrar Sesión',
                '¿Estás seguro de que deseas cerrar sesión?',
                performLogout,
                'logout'
            );
        });

        document.getElementById('profileBtn').addEventListener('click', () => {
            window.location.href = 'perfil.html';
        });

        document.getElementById('addVehicleBtn').addEventListener('click', () => {
            window.location.href = 'vehiculo-form.html';
        });

        document.getElementById('addFirstVehicle').addEventListener('click', () => {
            window.location.href = 'vehiculo-form.html';
        });

        document.getElementById('refreshBtn').addEventListener('click', async () => {
            await loadVehicles(1, getCurrentFilters());
        });

        // Filter event listeners
        document.getElementById('filterEstado').addEventListener('change', async () => {
            await loadVehicles(1, getCurrentFilters());
        });

        document.getElementById('filterTipo').addEventListener('change', async () => {
            await loadVehicles(1, getCurrentFilters());
        });

        document.getElementById('searchInput').addEventListener('input', debounce(() => {
            applyFilters();
        }, 300));

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            checkAuth();
            await loadVehicles();
        });
    </script>
</body>
</html>